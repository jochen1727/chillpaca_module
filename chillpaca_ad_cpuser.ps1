<#                                                                                              
      ⡾⣦⡀⠀⠀⡀⠀⣰⢷⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
  ⠀⣠⠗⠛⠽⠛⠋⠉⢳⡃⢨⢧⣄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⣰⠋⠁⠀⠀⠀   ⠀⠙⠛⢾⡈⡏⢧⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀                   
⣼⠉⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀ ⠀⠀⠘⢧⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠸⢦⡀⠀⠀⠀⠀⢀⠀⠀⠀⠀⠀⠀⠀⠀⢸⡄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⢈⠟⠓⠶⠞⠒⢻⣿⡏⢳⡀⠀⠀⠀⠀⢸⡆⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⡴⢉⠀⠀⠀⠀⠀⠈⠛⢁⣸⠇⠀⠀⠀⠀⢺⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⢧⣸⡁⠀⠀⣀⠀⠀⣠⠾⠀⠀⠀⠀⠀⠀⣹⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠉⠓⢲⠾⣍⣀⣀⡿⠃⠀⠀⠀⠀⠀⠀⢸⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⣇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⡿⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⣏⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣿⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⢀⡗⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⡼⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⢸⡄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢟⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⣸⠂⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠺⠦⠤⠤⣤⣄⣀⣀⡀⠀⠀⠀⠀⠀
⠀⠀⠀⣿⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠈⠉⠉⠳⣦⣄⠀⠀
⠀⠀⢀⡷⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠻⣆⠀
⠀⠀⣼⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠘⣆
⠀⠀⣏⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣿
⠀⠀⢹⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣼
⠀⠀⠀⣏⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⡞
⠀⠀⠀⠈⢷⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢠⡇
⠀⠀⠀⠀⠈⢻⣦⣀⠀⣏⠀⠀⠀⠀⠀⠀⢸⡆⠀⠀⢠⡄⠀⠀⠀⠀⠀⢀⡿⠀
⠀⠀⠀⠀⠀⠀⠻⡉⠙⢻⡆⠀⠀⠀⠀⠀⡾⠚⠓⣖⠛⣧⡀⠀⠀⠀⢀⡾⠁⠀
⠀⠀⠀⠀⠀⠀⠀⠙⡇⢀⡿⣦⡀⠀⢀⡴⠃⠀⠀⠈⣷⢈⠷⡆⠀⣴⠛⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠛⠚⠀⢸⡇⣰⠏⠁⠀⠀⠀⠀⢉⠁⢸⠷⠼⠃⠀

#>
#########################################################################################################script creation utilisateur#################################################################################################################################


# fonction cp_ad_createuser

function cp_ad_cpuser {
  <#
.SYNOPSIS
Fonction de creation d'un utilisateur dans l'ad et attribution d'une licence 365 microsoft
.DESCRIPTION
Fonction de creation d'un utilisateur dans l'ad et attribution d'une licence 365 microsoft en copiant un utilisateur existant a partir de son samaccount, neccessite d'avoir des droits administrateurs du domaine et de se connecter sur le controleur de domaine.
.PARAMETER prenom
indiquer le prenom de la personne a creer 
.PARAMETER nom
indiquer le nom de la personne a creer 
.PARAMETER samaccountreference
indiquer le samaccountreference de la personne de reference pour copier ses attributs
.PARAMETER motdepasse
indiquer le mot de passe de la personne (entre 12 et 20 characteres avec une majuscule, un chiffre et un charactere special '[!@#$%^&*()_+\-=\[\]{};':\\|,.<>\/?]`")
.PARAMETER societe
indiquer la societe de la personne voulu pour parametrer l upn, email ....
.PARAMETER creationdossiersmb
indiquer si oui ou non créé un dossier smb pour l utilisateur
.PARAMETER activerlicence365
indiquer si on veut créér une licence 365 pour l utilisateur
.EXAMPLE
cp_ad_createuser -prenom john -nom doe -samaccountreference jdoe2 -motdepasse azertyAZERTY_ -societe masociete -creationdossiersmb -activerlicence365
.LINK
https://github.com/jochen1727/
.NOTES
possibilite de se connecter a distance avec la commande invoke-command -computer $adresseduserveurad -script {cp_ad_createuser} ou une session a distance avec la commande enter-pssession
#>
  param (
    [parameter(mandatory = $true)]
    [string]$prenom,
    [parameter(mandatory = $true)]
    [string]$nom,
    [parameter(mandatory = $true)]
    [ValidateNotNullOrEmpty()]
    [Validatelength(3, 20)]
    [string]$samaccountreference,
    [parameter(mandatory = $true)]
    [Validatelength(12, 20)]
    [ValidateScript({ ($_ -match "[A-Z]") -and ($_ -match "[0-9]") -and ($_ -match "[!@#$%^&*()_+\-=\[\]{};:'\\|,.<>\/?]" ) })]
    [string]$motdepasse,
    [parameter(mandatory = $true)]
    [ValidateSet("lprh", "equinoxe", "rocard")]
    [string]$societe,
    [switch]$creationdossiersmb,
    [switch]$activerlicence365
  )
  #installations et importations modules si besoins
  Write-Host "-----------------------------------------installation RSAT et importations modules si necessaire----------------------------------------------------"
  $feature = Get-WindowsFeature -Name "RSAT-AD-PowerShell"
  if (-not $feature.Installed) {
    Install-WindowsFeature -Name "RSAT-AD-PowerShell" -IncludeAllSubFeature
  }
  else {
    Write-Host "La fonctionnalité 'RSAT-AD-PowerShell' est déjà installée."
  }
  if (-not (Get-Module -Name Microsoft.Graph.Beta -ListAvailable -ErrorAction SilentlyContinue)) {
    Write-Host "Le module MSGraph beta n'est pas installé. Installation en cours..."
    # Installer le module MSGraph beta 
    try {
      Install-Module -Name Microsoft.Graph.Beta -AllowPrerelease -Scope AllUsers -Force -Verbose
      Write-Host "Le module MSGraph beta a été installé avec succès."
    }
    catch {
      Write-Host "Une erreur s'est produite lors de l'installation du module MSGraph beta : $_" -ForegroundColor Red
    }
  }
  else {
 (write-host "Le module Ms Graph est déjà installéé.`nimportation du module Microsoft.Graph.Beta")
    import-module -name Microsoft.Graph.Beta
  }
  #fonction supprimer caracteres latin       
  function removestringlatincharacters {
    param (
      [string]$String
    )
    $bytes = [Text.Encoding]::GetEncoding("Cyrillic").GetBytes($String)
    [Text.Encoding]::ASCII.GetString($bytes)
  }
  #prenom et nom au bon format
  $prenom = RemoveStringLatinCharacters($prenom).ToLower()
  $nom = RemoveStringLatinCharacters($nom).ToLower()
  #Adresse email de la personne selon sa societe
  switch ($societe) {
    "lprh" {
      $societedns = "lepolerh.com"
    }
    "equinoxe" {
      $societedns = "equinoxe-expert.com"
    }
    "rocard" {
      $societedns = "crowe-rocard.fr"
    }
  }
  $email = $prenom + "." + $nom + "@" + $societedns
  $prenom = removestringlatincharacters($prenom)
  #nom complet de la personne avec la premiere lettre du prenom en majuscule et le nom en majuscule
  $fullname = $prenom.substring(0, 1).toupper() + $prenom.substring(1).tolower() + " " + $nom.ToUpper()
  #sam utilisateur et verification utilisateur present ou pas 
  $sam = .{
    $index = 0
    $x = ($prenom.toLower())[$index] + $nom.tolower()
    do {
      $usernameExists = try { $null = get-aduser $x; $true }catch { $false }
      if ($usernameExists) {
        $index += 1
        $x = (($prenom.toLower())[0..$index] -join '') + $nom.tolower()
      }
      else {
        return $x
      }
    }until(!$usernameExists -or $prenom.length + $nom.length -eq $x.length)
    $number = 1
    $x = ($prenom.toLower())[$index] + $nom.tolower()
    do {
      $y = $x + "$number"
      $usernameExists = try { $null = get-aduser $y; $true }catch { $false }
      if ($usernameExists) {
        $number += 1
        $y = $x + "$number"
      }
      else {
        return $y
      }      
    }until($number -ge 10000)
    return $null
  }
  if (!$sam) {
    write-warning "Utilisateur deja utilise."
    return $false
  }
  #UPN utilisateur
  $upn = $sam + '@' + $societedns
  $attributs_utilisateur_reference = Get-ADUser -Identity $samaccountreference -Properties StreetAddress, City, Title, PostalCode, Office, Department, Manager, co, st, Company                                                                                                                                                                
  #creation de du compte ad de l utilisateur
  Write-Host "-----------------------------------------ajouts groupes utilisateur-----------------------------------------------------"
  New-ADUser -Name $fullName -GivenName $prenom -Surname $nom -EmailAddress $email -SamAccountName $sam -DisplayName $fullName -UserPrincipalName $upn -Instance $attributs_utilisateur_reference  -AccountPassword (ConvertTo-SecureString $motdepasse -AsPlainText -Force) -ChangePasswordAtLogon $false -Enabled $true -PasswordNeverExpires $false
  $groupes_utilisateur_references = Get-ADPrincipalGroupMembership -Identity $samaccountreference -ErrorAction SilentlyContinue
  foreach ($groupe in $groupes_utilisateur_references) {
    # verifier si le groupe existe
    if (Get-ADGroup -Filter { Name -eq $groupe.name }) {
      # Verifier si l'utilisateur est déjà membre du groupe
      $estMembre = Get-ADGroupMember -Identity $groupe.name | Where-Object { $_.SamAccountName -eq $sam }
      # Si l'utilisateur n'est pas membre du groupe, l'ajouter
      if (-not $estMembre) {
        Add-ADGroupMember -Identity $groupe.name -Members $sam
        Write-Host "L'utilisateur $sam a été ajoute au groupe " $groupe.name
      }
      else {
        Write-Host "L'utilisateur $sam est déjà membre du groupe " $groupe.name
      }
    }
    else {
      Write-Host "Le groupe $groupe.name n'existe pas."
    }
  }
  Set-ADUser -Identity $sam -Add @{proxyAddresses = "SMTP:$email" } 
  $OU = ((Get-ADUser -Identity $samaccountreference).DistinguishedName -split '(?<!\\),', 2)[-1]
  $utilisateur = Get-ADUser -Identity $sam
  $utilisateur | move-ADObject -TargetPath $OU
  #resume des infos de l utilisateur
  Write-Host "-----------------------------------------resume utilisateur-----------------------------------------------------"
  Get-ADUser -Filter "UserPrincipalName -eq '$upn'" -Properties * | Select-Object enabled, objectSid, GivenName, Surname, DisplayName, UserPrincipalName, Mail, proxyAddresses, Title, Department, OfficeLocation, AssignedLicenses, DistinguishedName, @{name = "groupes"; Expression = { (Get-ADPrincipalGroupMembership -Identity $sam | Select-Object -ExpandProperty Name) -join ', ' } }
  #ceation dossier utilisateur SCAN
  Write-Host "-----------------------------------------creation dossier scan--------------------------------------------------"
  if ($creationdossiersmb) {
    $dossier_utilisateur = $prenom.toupper().Substring(0, 1) + $nom.toupper().Substring(0, 2)
    Invoke-Command -ComputerName srv-fs01 -ScriptBlock { new-item "D:\Rocard\Commun\Scan\Individuel\${using:dossier_utilisateur}" -Type directory }
    
  }
  #Connexion a Msgraph avec les infos de l application
  if ($activerlicence365) {
    $ClientId = "13f257d8-b7f4-486f-87f7-e287efc5ab9b"
    $TenantId = "ad1d5291-d8d6-488c-8aed-1b731fd644d2"
    $ClientSecret = "hrf8Q~o7x7QThabbON0lH3ebXb-w58qFefriEcxY"
    $Body = @{
      Grant_Type    = "client_credentials"
      Scope         = "https://graph.microsoft.com/.default"
      Client_Id     = $ClientId
      Client_Secret = $ClientSecret
    }
    # Récupérer le jeton d'accès
    $Connection = Invoke-RestMethod -Uri "https://login.microsoftonline.com/$TenantId/oauth2/v2.0/token" -Method POST -Body $Body
    # Récupérer le jeton d'accès
    $token = $Connection.access_token
    # Convertir le jeton d'accès en SecureString
    $SecureToken = ConvertTo-SecureString $token -AsPlainText -Force
    # Se connecter à Microsoft Graph en utilisant le jeton d'accès sécurisé
    Connect-MgGraph -AccessToken $SecureToken -NoWelcome
    Write-Host "------------------------------------Synchro AD/365 (30 minutes)-----------------------------------------------"
    Start-ADSyncSyncCycle -PolicyType initial
    Start-Sleep -Seconds 1800
    $usageLocation = 'FR'
    update-mguser -UserId (Get-MgUser -UserId $upn).Id -usagelocation $usageLocation
    # Ajout de la licence 365 desire a l utilisateur
    # Liste des applications à désactiver
    $apps = @(
      "Bing_Chat_Enterprise",
      "MESH_IMMERSIVE_FOR_TEAMS",
      "MESH_AVATARS_ADDITIONAL_FOR_TEAMS",
      "MESH_AVATARS_FOR_TEAMS",
      "M365_LIGHTHOUSE_CUSTOMER_PLAN1",
      "VIVAENGAGE_CORE",
      "MICROSOFTBOOKINGS",
      "RMS_S_BASIC",
      "VIVA_LEARNING_SEEDED",
      "Nucleus",
      "POWER_VIRTUAL_AGENTS_O365_P1",
      #"CDS_O365_P1",
      #"PROJECT_O365_P1",
      #"DYN365_CDS_O365_P1",
      "MICROSOFT_SEARCH",
      "WHITEBOARD_PLAN1",
      "MYANALYTICS_P2",
      "KAIZALA_O365_P2",
      "STREAM_O365_SMB",
      #"OFFICEMOBILE_SUBSCRIPTION",
      "BPOS_S_TODO_1",
      "FORMS_PLAN_E1",
      "FLOW_O365_P1",
      "POWERAPPS_O365_P1",
      #"TEAMS1",
      "PROJECTWORKMANAGEMENT",
      "SWAY",
      "INTUNE_O365",
      #"SHAREPOINTWAC",
      "YAMMER_ENTERPRISE",
      #"EXCHANGE_S_STANDARD",
      "MCOSTANDARD"
      #"SHAREPOINTSTANDARD"
    )
    $o365Sku = Get-MgSubscribedSku -All | Where-Object SkuPartNumber -eq 'O365_BUSINESS_ESSENTIALS'
    $filteredPlans = $o365Sku.ServicePlans | Where-Object {
      $_.ServiceplanName -in $apps
    }
    $filteredPlans | Select-Object @{Name = "ServicePlanId"; Expression = { $_.ServicePlanId } }
    $addLicenses = @{
      SkuId         = $o365Sku.SkuId
      DisabledPlans = $filteredPlans.serviceplanid
    }
    Set-MgUserLicense -UserId (Get-MgUser -UserId $upn).Id -Addlicenses $addLicenses -RemoveLicenses @() -ErrorAction Ignore -Wharn
  }
  if ($activerlicence365) {
    Write-Host "----------------------------------licences Microsoft 365 de l utilisateur---------------------------------------"
    Get-MgUserLicenseDetail -UserId (Get-MgUser -UserId $upn).Id | select-object SkuPartNumber, ServicePlans | format-table -Wrap
    Write-Host "----------------------------------licences Microsoft 365 utilisees----------------------------------------------"
    Get-MgSubscribedSku | select SkuId, SkuPartNumber,ConsumedUnits,ServicePlans | ft -AutoSize
  }
}

