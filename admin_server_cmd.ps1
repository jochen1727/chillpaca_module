
<#                                                                                              
      ⡾⣦⡀⠀⠀⡀⠀⣰⢷⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
  ⠀⣠⠗⠛⠽⠛⠋⠉⢳⡃⢨⢧⣄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⣰⠋⠁⠀⠀⠀   ⠀⠙⠛⢾⡈⡏⢧⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀                   
⣼⠉⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀ ⠀⠀⠘⢧⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠸⢦⡀⠀⠀⠀⠀⢀⠀⠀⠀⠀⠀⠀⠀⠀⢸⡄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⢈⠟⠓⠶⠞⠒⢻⣿⡏⢳⡀⠀⠀⠀⠀⢸⡆⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⡴⢉⠀⠀⠀⠀⠀⠈⠛⢁⣸⠇⠀⠀⠀⠀⢺⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⢧⣸⡁⠀⠀⣀⠀⠀⣠⠾⠀⠀⠀⠀⠀⠀⣹⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠉⠓⢲⠾⣍⣀⣀⡿⠃⠀⠀⠀⠀⠀⠀⢸⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⣇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⡿⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⣏⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣿⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⢀⡗⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⡼⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⢸⡄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢟⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⣸⠂⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠺⠦⠤⠤⣤⣄⣀⣀⡀⠀⠀⠀⠀⠀
⠀⠀⠀⣿⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠈⠉⠉⠳⣦⣄⠀⠀
⠀⠀⢀⡷⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠻⣆⠀
⠀⠀⣼⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠘⣆
⠀⠀⣏⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣿
⠀⠀⢹⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣼
⠀⠀⠀⣏⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⡞
⠀⠀⠀⠈⢷⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢠⡇
⠀⠀⠀⠀⠈⢻⣦⣀⠀⣏⠀⠀⠀⠀⠀⠀⢸⡆⠀⠀⢠⡄⠀⠀⠀⠀⠀⢀⡿⠀
⠀⠀⠀⠀⠀⠀⠻⡉⠙⢻⡆⠀⠀⠀⠀⠀⡾⠚⠓⣖⠛⣧⡀⠀⠀⠀⢀⡾⠁⠀
⠀⠀⠀⠀⠀⠀⠀⠙⡇⢀⡿⣦⡀⠀⢀⡴⠃⠀⠀⠈⣷⢈⠷⡆⠀⣴⠛⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠛⠚⠀⢸⡇⣰⠏⠁⠀⠀⠀⠀⢉⠁⢸⠷⠼⠃⠀

#>
#########################################################################################################commandes utiles powershell#################################################################################################################################



#################################################################################################Fichiers###########################################################################################################################################################
# obtenir taille gros fichiers
Get-ChildItem -Recurse -File | where-object-Object { $_.Length -gt 100MB } | Select-Object Name, FullName, @{n="SizeGB";e={"{0:N2}" -f ($_.Length / 1000MB)}} | export-csv files.csv
# obtenir taille dossiers
Get-ChildItem -Path c:\ -Depth 2  | Measure-Object -Property Length -Sum | Select-Object @{Name="Size";Expression={"{0:N2} {1}" -f ($_.Sum / 1GB), "GB"}}
# recherche un type de fichier
ls -Path "C:\" -Recurse -file -Exclude "C:\Users","C:\Windows" -ErrorAction SilentlyContinue | where {$_.Name -match "\.dmp"} | rm -force
################################################################################################ Microsoft 365######################################################################################################################################################
# gerer microsoft 365 avec microsoft graph
Install-Module Microsoft.Graph -Scope "User.ReadWrite.All", "Group.ReadWrite.All", "Directory.ReadWrite.All" -AllowClobber -Force 
connect-mggraph
Disconnect-MgGraph
#connecter a exchange 365
connect-exchangeonline
#ajout BAL /modification/supression sur un autre utilisateur
Add-MailboxPermission -Identity "dijon lph" -user msinssaine@lepolerh.com -accessrights fullaccess -confirm:$false -AutoMapping:$true
set-mailboxfolderPermission -Identity "Chatillon-SALLE@crowe-rocard.fr:\calendar" -user -AccessRights reviewer
Remove-MailboxPermission -Identity "dijon lph" -user msinssaine@lepolerh.com -AccessRights fullaccess -Confirm:$false
#ajout BAL pour plusieurs utilisateurs
Get-Mailbox | where-object-object -property name -match salle | foreach-object-object {Add-MailboxPermission -Identity $_.name -User emorizot@crowe-rocard.fr -AccessRights fullaccess -InheritanceType all}
#envoye en tant que
Add-RecipientPermission -Identity <boite_aux_lettres> -Trustee <utilisateur> -AccessRights SendAs
#envoye en tant que pour plusieurs utilisateurs
Get-Mailbox | where-object -property name -match salle | foreach-object {Add-RecipientPermission -Identity $_.name -Trustee fvermi@crowe-rocard.fr -AccessRights sendas -Confirm:$false }
#envoye de la part de
Set-Mailbox -Identity <boite_aux_lettres> -GrantSendOnBehalfTo <utilisateur>
#envoye de la part de pour plusieurs utilisateurs
Get-Mailbox | where-object -property name -match salle | foreach-object {Set-Mailbox -Identity <boite_aux_lettres> -GrantSendOnBehalfTo <utilisateur> -confirm:$false }
#cache une BAL de la GAL
Set-Mailbox "nom_boite_aux_lettres" -HiddenFromAddressListsEnabled $true

#licence azure
#https://learn.microsoft.com/en-us/microsoft-365/enterprise/assign-licenses-to-user-accounts-with-microsoft-365-powershell?view=o365-worldwide
$e5Sku = Get-MgSubscribedSku -All | Where SkuPartNumber -eq 'SPE_E5'
Set-MgUserLicense -UserId $upn -AddLicenses @{SkuId = $e5Sku.SkuId} -RemoveLicenses @()
#################################################################################################controleur de domaine###################################################################################################################################################
#voir soucis replication
Get-ADReplicationFailure –Scope DOMAIN –Target mondomaine
#infos pour les replications dc
Get-ADReplicationPartnerMetadata -Target dc
Get-ADReplicationPartnerMetadata –Target * -Scope Server | Where {$_.LastReplicationResult –ne "0"} | Format-Table Server, LastReplicationAttempt, LastReplicationResult, Partner, Site
Get-ADReplicationQueueOperation -Server dc
Get-ADReplicationAttributeMetadata -Object "DC=test,DC=local" -Server dc -ShowAllLinkedValues
#infos pour les replications sites
Get-ADReplicationSite -Filter *
Get-ADReplicationSiteLink -Filter *
Get-ADReplicationSiteLinkBridge -Filter *
Get-ADReplicationSubnet -Filter *	
#repliquer objet
Sync-ADObject -Object 'DC=Domain,DC=local' -Source dc
#repliquer dc tous les sites
repadmin /syncall /Aped
repadmin /showrepl
repadmin /replsum

