<#                                                                                              
      ⡾⣦⡀⠀⠀⡀⠀⣰⢷⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
  ⠀⣠⠗⠛⠽⠛⠋⠉⢳⡃⢨⢧⣄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⣰⠋⠁⠀⠀⠀   ⠀⠙⠛⢾⡈⡏⢧⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀                   
⣼⠉⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀ ⠀⠀⠘⢧⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠸⢦⡀⠀⠀⠀⠀⢀⠀⠀⠀⠀⠀⠀⠀⠀⢸⡄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⢈⠟⠓⠶⠞⠒⢻⣿⡏⢳⡀⠀⠀⠀⠀⢸⡆⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⡴⢉⠀⠀⠀⠀⠀⠈⠛⢁⣸⠇⠀⠀⠀⠀⢺⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⢧⣸⡁⠀⠀⣀⠀⠀⣠⠾⠀⠀⠀⠀⠀⠀⣹⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠉⠓⢲⠾⣍⣀⣀⡿⠃⠀⠀⠀⠀⠀⠀⢸⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⣇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⡿⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⣏⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣿⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⢀⡗⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⡼⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⢸⡄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢟⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⣸⠂⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠺⠦⠤⠤⣤⣄⣀⣀⡀⠀⠀⠀⠀⠀
⠀⠀⠀⣿⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠈⠉⠉⠳⣦⣄⠀⠀
⠀⠀⢀⡷⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠻⣆⠀
⠀⠀⣼⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠘⣆
⠀⠀⣏⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣿
⠀⠀⢹⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣼
⠀⠀⠀⣏⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⡞
⠀⠀⠀⠈⢷⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢠⡇
⠀⠀⠀⠀⠈⢻⣦⣀⠀⣏⠀⠀⠀⠀⠀⠀⢸⡆⠀⠀⢠⡄⠀⠀⠀⠀⠀⢀⡿⠀
⠀⠀⠀⠀⠀⠀⠻⡉⠙⢻⡆⠀⠀⠀⠀⠀⡾⠚⠓⣖⠛⣧⡀⠀⠀⠀⢀⡾⠁⠀
⠀⠀⠀⠀⠀⠀⠀⠙⡇⢀⡿⣦⡀⠀⢀⡴⠃⠀⠀⠈⣷⢈⠷⡆⠀⣴⠛⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠛⠚⠀⢸⡇⣰⠏⠁⠀⠀⠀⠀⢉⠁⢸⠷⠼⠃⠀

#>
#########################################################################################################chillpaca_ad_createuser#################################################################################################################################
<#
.SYNOPSIS
Fonction de creation d'un utilisateur dans l'ad et attribution d'une licence 365 microsoft
.DESCRIPTION
Fonction de creation d'un utilisateur dans l'ad et attribution d'une licence 365 microsoft à partir de caracteristiques dans un fichier csv.
.PARAMETER cheminfichiercsv
emplacement du fichier avec les informations.
.PARAMETER activerlicence365
Active ou non l'attribution de la licence microsoft365 pour l'utilisateur (parametre non obligatoire)
.EXAMPLE
cp_ad_createuser -cheminfichiercsv "emplacement du fichier csv" -activerlicence365
.LINK
https://github.com/jochen1727/
.NOTES
possibilite de se connecter a distance avec la commande invoke-command -computer $adresseduserveurad -script {cp_ad_createuser} ou une session a distance avec la commande enter-pssession
il faut au prealable indiquer les elements $ClientId  $TenantId  $ClientSecret configure dans le tenant 365
#>
function cp_ad_createuser {
  param (
    [parameter(mandatory = $true)]
    [string]$cheminfichiercsv,
    [switch]$activerlicence365
  )
  #installations et importations modules si besoins
  Write-Host "-----------------------------------------installation RSAT et importations modules si necessaire----------------------------------------------------"
  $feature = Get-WindowsFeature -Name "RSAT-AD-PowerShell"
  if (-not $feature.Installed) {
    Install-WindowsFeature -Name "RSAT-AD-PowerShell" -IncludeAllSubFeature
  }
  else {
    Write-Host "La fonctionnalité 'RSAT-AD-PowerShell' est déjà installée."
  }
  if (-not (Get-Module -Name Microsoft.Graph.Beta -ListAvailable -ErrorAction SilentlyContinue)) {
    Write-Host "Le module MSGraph beta n'est pas installé. Installation en cours..."
    # Installer le module MSGraph beta 
    try {
      Install-Module -Name Microsoft.Graph.Beta -AllowPrerelease -Scope AllUsers -Force -Verbose
      Write-Host "Le module MSGraph beta a été installé avec succès."
    }
    catch {
      Write-Host "Une erreur s'est produite lors de l'installation du module MSGraph beta : $_" -ForegroundColor Red
    }
  }
  else {
 (write-host "Le module Ms Graph est déjà installéé.`n importation du module Microsoft.Graph.Beta")
    import-module -name Microsoft.Graph.Beta
  }
  #importation des utilisateurs depuis le fichier CSV
  $utilisateurs = Import-CSV -Path $cheminfichiercsv -Delimiter ';'
  #creation de l utilisateur
  foreach ($utilisateur in $utilisateurs) {
    # Formatage du SamAccountName : première lettre du prénom + nom, limité à 20 caractères
    $samAccountName = $utilisateur.prenom.Substring(0, 1) + $utilisateur.nom
    $proxyAddresses = "SMTP:" + $utilisateur.addresseemail
    # Tentative de création d'un nouvel utilisateur AD
    try {
      New-ADUser -SamAccountName $samAccountName `
        -UserPrincipalName $utilisateur.upn `
        -Name ("{0} {1}" -f $utilisateur.prenom, $utilisateur.nom) `
        -GivenName $utilisateur.prenom `
        -Surname $utilisateur.nom `
        -Enabled $true `
        -DisplayName ("{0} {1}" -f $utilisateur.prenom, $utilisateur.nom) `
        -Email $utilisateur.adresseprincipale `
        -AccountPassword (ConvertTo-SecureString $utilisateur.password -AsPlainText -Force) `
        -Path $utilisateur.cheminou `
        -PasswordNeverExpires $true `
        -CannotChangePassword $false `
        -ErrorAction Stop `
        -Department $utilisateur.departement `
        -Title $utilisateur.poste `
        -Company $utilisateur.entreprise

      #ajout de l adresse principale et les adresses secondaires
      $upn = $utilisateur.$upn
      $adresseprincipale = "SMTP:" + $utilisateur.adresseprincipale
      $adressessecondaires = $utilisateur.adressessecondaires -split ',' | ForEach-Object { "smtp:" + $_ }
      $proxyAddresses = @($adresseprincipale) + $adressessecondaires
      try {
        Set-ADUser -Identity $samAccountName -Add @{ proxyAddresses = $proxyAddresses }
      }
      catch {
        Write-Error "Erreur lors de la mise à jour du parametre proxyadresses de $($utilisateur.SamAccountName): $_"
      }    
      #ajout de groupes
      $groupes = $utilisateur.Groupes -split ','
      foreach ($groupe in $groupes) {
        try {
          Add-ADGroupMember -Identity $groupe -Members $samAccountName
          Write-Host "Utilisateur $($samAccountName) ajouté au groupe $groupe."
        }
        catch {
          Write-Warning "Impossible d'ajouter l'utilisateur $($samAccountName) au groupe $groupe : $_"
        }
      }
      #informations utilisateurs
      $infos = @()
      $infos += Get-ADUser -Filter "SamAccountName -eq `"$samAccountName`"" -Properties * | Select-Object enabled, objectSid, GivenName, Surname, DisplayName, UserPrincipalName, Mail, proxyAddresses, Title, Department, OfficeLocation, AssignedLicenses, DistinguishedName, @{name = "groupes"; Expression = { (Get-ADPrincipalGroupMembership -Identity $samAccountName | Select-Object -ExpandProperty Name) -join ', ' } }
    }
    catch {
      Write-Warning "Impossible de créer l'utilisateur $($utilisateur.prenom) $($utilisateur.nom): $_"
    }
        
    $infos | Format-List
        
  }
   
  if ($activerlicence365) {
    $ClientId = "13f257d8-b7f4-486f-87f7-e287efc5ab9b"
    $TenantId = "ad1d5291-d8d6-488c-8aed-1b731fd644d2"
    $ClientSecret = "hrf8Q~o7x7QThabbON0lH3ebXb-w58qFefriEcxY"
    $Body = @{
      Grant_Type    = "client_credentials"
      Scope         = "https://graph.microsoft.com/.default"
      Client_Id     = $ClientId
      Client_Secret = $ClientSecret
    }
    # Récupérer le jeton d'accès
    $Connection = Invoke-RestMethod -Uri "https://login.microsoftonline.com/$TenantId/oauth2/v2.0/token" -Method POST -Body $Body
    # Récupérer le jeton d'accès
    $token = $Connection.access_token
    # Convertir le jeton d'accès en SecureString
    $SecureToken = ConvertTo-SecureString $token -AsPlainText -Force
    # Se connecter à Microsoft Graph en utilisant le jeton d'accès sécurisé
    Connect-MgGraph -AccessToken $SecureToken -NoWelcome
    Write-Host "------------------------------------Synchro AD/365 (30 minutes)-----------------------------------------------"
    Start-ADSyncSyncCycle -PolicyType initial
    Start-Sleep -Seconds 1800
    $usageLocation = 'FR'
    update-mguser -UserId (Get-MgUser -UserId $upn).Id -usagelocation $usageLocation
    # Ajout de la licence 365 desire a l utilisateur
    # Liste des applications à désactiver
    $apps = @(
      "Bing_Chat_Enterprise",
      "MESH_IMMERSIVE_FOR_TEAMS",
      "MESH_AVATARS_ADDITIONAL_FOR_TEAMS",
      "MESH_AVATARS_FOR_TEAMS",
      "M365_LIGHTHOUSE_CUSTOMER_PLAN1",
      "VIVAENGAGE_CORE",
      "MICROSOFTBOOKINGS",
      "RMS_S_BASIC",
      "VIVA_LEARNING_SEEDED",
      "Nucleus",
      "POWER_VIRTUAL_AGENTS_O365_P1",
      #"CDS_O365_P1",
      #"PROJECT_O365_P1",
      #"DYN365_CDS_O365_P1",
      "MICROSOFT_SEARCH",
      "WHITEBOARD_PLAN1",
      "MYANALYTICS_P2",
      "KAIZALA_O365_P2",
      "STREAM_O365_SMB",
      #"OFFICEMOBILE_SUBSCRIPTION",
      "BPOS_S_TODO_1",
      "FORMS_PLAN_E1",
      "FLOW_O365_P1",
      "POWERAPPS_O365_P1",
      #"TEAMS1",
      "PROJECTWORKMANAGEMENT",
      "SWAY",
      "INTUNE_O365",
      #"SHAREPOINTWAC",
      "YAMMER_ENTERPRISE",
      #"EXCHANGE_S_STANDARD",
      "MCOSTANDARD"
      #"SHAREPOINTSTANDARD"
    )
    $o365Sku = Get-MgSubscribedSku -All | Where-Object SkuPartNumber -eq 'O365_BUSINESS_ESSENTIALS'
    $filteredPlans = $o365Sku.ServicePlans | Where-Object {
      $_.ServiceplanName -in $apps
    }
    $filteredPlans | Select-Object @{Name = "ServicePlanId"; Expression = { $_.ServicePlanId } }
    $addLicenses = @{
      SkuId         = $o365Sku.SkuId
      DisabledPlans = $filteredPlans.serviceplanid
    }
    Set-MgUserLicense -UserId (Get-MgUser -UserId $upn).Id -Addlicenses $addLicenses -RemoveLicenses @() 
  }
  if ($activerlicence365) {
    Write-Host "----------------------------------licences Microsoft 365 de l utilisateur---------------------------------------"
    Get-MgUserLicenseDetail -UserId (Get-MgUser -UserId $upn).Id | select-object SkuPartNumber, ServicePlans | format-table -AutoSize
    Write-Host "----------------------------------licences Microsoft 365 utilisees----------------------------------------------"
    Get-MgSubscribedSku
  }
}