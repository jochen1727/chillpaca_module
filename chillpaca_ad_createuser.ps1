<#                                                                                              
      ⡾⣦⡀⠀⠀⡀⠀⣰⢷⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
  ⠀⣠⠗⠛⠽⠛⠋⠉⢳⡃⢨⢧⣄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⣰⠋⠁⠀⠀⠀   ⠀⠙⠛⢾⡈⡏⢧⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀                   
⣼⠉⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀ ⠀⠀⠘⢧⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠸⢦⡀⠀⠀⠀⠀⢀⠀⠀⠀⠀⠀⠀⠀⠀⢸⡄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⢈⠟⠓⠶⠞⠒⢻⣿⡏⢳⡀⠀⠀⠀⠀⢸⡆⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⡴⢉⠀⠀⠀⠀⠀⠈⠛⢁⣸⠇⠀⠀⠀⠀⢺⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⢧⣸⡁⠀⠀⣀⠀⠀⣠⠾⠀⠀⠀⠀⠀⠀⣹⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠉⠓⢲⠾⣍⣀⣀⡿⠃⠀⠀⠀⠀⠀⠀⢸⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⣇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⡿⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⣏⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣿⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⢀⡗⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⡼⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⢸⡄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢟⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⣸⠂⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠺⠦⠤⠤⣤⣄⣀⣀⡀⠀⠀⠀⠀⠀
⠀⠀⠀⣿⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠈⠉⠉⠳⣦⣄⠀⠀
⠀⠀⢀⡷⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠻⣆⠀
⠀⠀⣼⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠘⣆
⠀⠀⣏⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣿
⠀⠀⢹⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣼
⠀⠀⠀⣏⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⡞
⠀⠀⠀⠈⢷⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢠⡇
⠀⠀⠀⠀⠈⢻⣦⣀⠀⣏⠀⠀⠀⠀⠀⠀⢸⡆⠀⠀⢠⡄⠀⠀⠀⠀⠀⢀⡿⠀
⠀⠀⠀⠀⠀⠀⠻⡉⠙⢻⡆⠀⠀⠀⠀⠀⡾⠚⠓⣖⠛⣧⡀⠀⠀⠀⢀⡾⠁⠀
⠀⠀⠀⠀⠀⠀⠀⠙⡇⢀⡿⣦⡀⠀⢀⡴⠃⠀⠀⠈⣷⢈⠷⡆⠀⣴⠛⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠛⠚⠀⢸⡇⣰⠏⠁⠀⠀⠀⠀⢉⠁⢸⠷⠼⠃⠀

#>
#########################################################################################################script creation utilisateur#################################################################################################################################


# fonction cp_ad_createuser

function cp_ad_createuser {
  <#
.SYNOPSIS
Fonction de creation d'un utilisateur dans l'ad et attribution d'une licence 365 microsoft
.DESCRIPTION
Fonction de creation d'un utilisateur dans l'ad et attribution d'une licence 365 microsoft en copiant un utilisateur existant a partir de son samaccount, neccessite d'avoir des droits administrateurs du domaine et de se connecter sur le controleur de domaine.
.PARAMETER prenom
indiquer le prenom de la personne a creer 
.PARAMETER nom
indiquer le nom de la personne a creer 
.PARAMETER samaccountreference
indiquer le samaccountreference de la personne de reference pour copier ses attributs
.PARAMETER motdepasse
indiquer le mot de passe de la personne (entre 12 et 20 characteres avec une majuscule, un chiffre et un charactere special '[!@#$%^&*()_+\-=\[\]{};':\\|,.<>\/?]`")
.PARAMETER samaccountreference
indiquer la societe de la personne pour son adresse email, sont adresse upn
.PARAMETER identifiantmicrosoftentra
indiquer les identifiants microsoft entra
.EXAMPLE
cp_ad_createuser -prenom john -nom doe -motdepasse azertyAZERTY_ -societe masociete -$identifiantmicrosoftentra
.LINK
https://github.com/jochen1727/
.NOTES
possibilite de se connecter a distance avec la commande invoke-command -computer $adresseduserveurad -script {cp_ad_createuser} ou une session a distance avec la commande enter-pssession
#>
  param (
    [parameter(mandatory = $true)]
    [string]$prenom,
    [parameter(mandatory = $true)]
    [string]$nom,
    [parameter(mandatory = $true)]
    [ValidateNotNullOrEmpty()]
    [Validatelength(3, 20)]
    [string]$samaccountreference,
    [parameter(mandatory = $true)]
    [Validatelength(12, 20)]
    [ValidateScript({ ($_ -match "[A-Z]") -and ($_ -match "[0-9]") -and ($_ -match "[!@#$%^&*()_+\-=\[\]{};:'\\|,.<>\/?]" ) })]
    [string]$motdepasse,
    [parameter(mandatory = $true)]
    [ValidateSet("lprh", "equinoxe", "rocard")]
    [string]$societe
    #[parameter(mandatory=$true)]
    #[PSCredential]$identifiantmicrosoftentra
  )
  begin {
    #installations et importations modules si besoins
    Add-WindowsFeature -Name "RSAT-AD-PowerShell" -IncludeAllSubFeature
    Import-Module ActiveDirectory
    $modules = @("azuread", "msonline", "Microsoft.Graph")
    foreach ($module in $modules) {
      if (-not (Get-Module -Name $module -ListAvailable)) {
        Install-Module -Name $module -Force -AllowClobber
      }
      Import-Module $module
    }
    #fonction affichage lignes 
    function line {
      return (
        write-output "
----------------------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------------------
"
      )
    }  
    #fonction supprimer caracteres latin                                                                                                                                                                              
    function removestringlatincharacters {
      param (
        [string]$String
      )
      $bytes = [Text.Encoding]::GetEncoding("Cyrillic").GetBytes($String)
      [Text.Encoding]::ASCII.GetString($bytes)
    }
    #prenom et nom au bon format
    $prenom = RemoveStringLatinCharacters($prenom).ToLower()
    $nom = RemoveStringLatinCharacters($nom).ToLower()
    #Adresse email de la personne selon sa societe
    switch ($societe) {
      "lprh" {
        $societedns = "lepolerh.com"
      }
      "equinoxe" {
        $societedns = "equinoxe-expert.com"
      }
      "rocard" {
        $societedns = "crowe-rocard.fr"
      }
    }
    $email = $prenom + "." + $nom + "@" + $societedns
    $prenom = removestringlatincharacters($prenom)
    #nom complet de la personne avec la premiere lettre du prenom en majuscule et le nom en majuscule
    $fullname = $prenom.substring(0, 1).toupper() + $prenom.substring(1).tolower() + " " + $nom.ToUpper()
    #sam utilisateur et vÃ©rification utilisateur prÃ©sent ou pas 
    $sam = .{
      $index = 0
      $x = ($prenom.toLower())[$index] + $nom.tolower()
      do {
        $usernameExists = try { $null = get-aduser $x; $true }catch { $false }
        if ($usernameExists) {
          $index += 1
          $x = (($prenom.toLower())[0..$index] -join '') + $nom.tolower()
        }
        else {
          return $x
        }
      }until(!$usernameExists -or $prenom.length + $nom.length -eq $x.length)
      $number = 1
      $x = ($prenom.toLower())[$index] + $nom.tolower()
      do {
        $y = $x + "$number"
        $usernameExists = try { $null = get-aduser $y; $true }catch { $false }
        if ($usernameExists) {
          $number += 1
          $y = $x + "$number"
        }
        else {
          return $y
        }      
      }until($number -ge 10000)
      return $null
    }
    if (!$sam) {
      write-warning "Utilisateur deja utilise."
      return $false
    }
    #UPN utilisateur
    $upn = $sam + '@' + $societedns
    $attributs_utilisateur_reference = Get-ADUser -Identity $samaccountreference -Properties StreetAddress, City, Title, PostalCode, Office, Department, Manager, co, st, Company
  }
  process {
    #creation de du compte ad de l utilisateur
    New-ADUser -Name $fullName -GivenName $prenom -Surname $nom -EmailAddress $email -SamAccountName $sam -DisplayName $fullName -UserPrincipalName $upn -Instance $attributs_utilisateur_reference  -AccountPassword (ConvertTo-SecureString $motdepasse -AsPlainText -Force) -ChangePasswordAtLogon $false -Enabled $true -PasswordNeverExpires $false
    $groupes_utilisateur_references = Get-ADPrincipalGroupMembership -Identity $samaccountreference 
    Add-ADPrincipalGroupMembership -Identity $sam -MemberOf $groupes_utilisateur_references
    Set-ADUser -Identity $sam -Add @{proxyAddresses = "SMTP:$email" } 
    $OU = ((Get-ADUser -Identity $samaccountreference).DistinguishedName -split '(?<!\\),', 2)[-1]
    $utilisateur = Get-ADUser -Identity $sam
    $utilisateur | move-ADObject -TargetPath $OU
    #ceation dossier utilisateur SCAN
    $dossier_utilisateur = $prenom.toupper().Substring(0, 1) + $nom.toupper().Substring(0, 2)
    Invoke-Command -ComputerName srv-fs01 -ScriptBlock { new-item "D:\Rocard\Commun\Scan\Individuel\dossier_utilisateur" -Type directory }
  }
  end {
    #Forcer synchro AD connect
    Start-ADSyncSyncCycle -PolicyType initial
    Start-Sleep -Seconds 1800
    $usageLocation = 'FR'
    Connect-MgGraph -Scopes "User.Read.All", "Group.Read.All", "Directory.ReadWrite.All"
    update-mguser -UserId $upn -usagelocation $usageLocation
    Set-MgUserLicense -UserId (Get-MgUser -UserId $upn).Id -Addlicenses @{SkuId = '3b555118-da6a-4418-894f-7df1e2096870’ } -RemoveLicenses @()
    #resume des infos de l utilisateur
    line
    Write-Host "-----------------------------------------resume utilisateur-----------------------------------------------------"
    Get-MgUser -UserId $upn | Select ID, GivenName, Surname, DisplayName, UserPrincipalName, Mail, proxyAddresses, JobTitle, Department, OfficeLocation, AssignedLicenses
    Write-Host "-----------------------------------------groupes de l utilisateur-----------------------------------------------"
    Get-MgUserTransitiveMemberOf -UserId $upn -Property displayName | ? { $_.AdditionalProperties.'@odata.type' -eq "#microsoft.graph.group" } | select @{n = "Name"; e = { $_.AdditionalProperties.displayName } } 
    Get-MgUserOwnedObject -UserId $upn -Property id, displayName | select @{n = "Name"; e = { $_.AdditionalProperties.displayName } }
    Write-Host "----------------------------------licences Microsoft 365 de l utilisateur---------------------------------------"
    Get-MgUserLicenseDetail -UserId $upn | select SkuPartNumber, ServicePlans | ft -AutoSize
    line
    Write-Host "----------------------------------licences Microsoft 365 utilisees----------------------------------------------"
    Get-MgSubscribedSku
  }
}
