<#                                                                                              
      ⡾⣦⡀⠀⠀⡀⠀⣰⢷⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
  ⠀⣠⠗⠛⠽⠛⠋⠉⢳⡃⢨⢧⣄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⣰⠋⠁⠀⠀⠀   ⠀⠙⠛⢾⡈⡏⢧⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀                   
⣼⠉⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀ ⠀⠀⠘⢧⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠸⢦⡀⠀⠀⠀⠀⢀⠀⠀⠀⠀⠀⠀⠀⠀⢸⡄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⢈⠟⠓⠶⠞⠒⢻⣿⡏⢳⡀⠀⠀⠀⠀⢸⡆⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⡴⢉⠀⠀⠀⠀⠀⠈⠛⢁⣸⠇⠀⠀⠀⠀⢺⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⢧⣸⡁⠀⠀⣀⠀⠀⣠⠾⠀⠀⠀⠀⠀⠀⣹⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠉⠓⢲⠾⣍⣀⣀⡿⠃⠀⠀⠀⠀⠀⠀⢸⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⣇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⡿⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⣏⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣿⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⢀⡗⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⡼⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⢸⡄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢟⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⣸⠂⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠺⠦⠤⠤⣤⣄⣀⣀⡀⠀⠀⠀⠀⠀
⠀⠀⠀⣿⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠈⠉⠉⠳⣦⣄⠀⠀
⠀⠀⢀⡷⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠻⣆⠀
⠀⠀⣼⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠘⣆
⠀⠀⣏⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣿
⠀⠀⢹⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣼
⠀⠀⠀⣏⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⡞
⠀⠀⠀⠈⢷⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢠⡇
⠀⠀⠀⠀⠈⢻⣦⣀⠀⣏⠀⠀⠀⠀⠀⠀⢸⡆⠀⠀⢠⡄⠀⠀⠀⠀⠀⢀⡿⠀
⠀⠀⠀⠀⠀⠀⠻⡉⠙⢻⡆⠀⠀⠀⠀⠀⡾⠚⠓⣖⠛⣧⡀⠀⠀⠀⢀⡾⠁⠀
⠀⠀⠀⠀⠀⠀⠀⠙⡇⢀⡿⣦⡀⠀⢀⡴⠃⠀⠀⠈⣷⢈⠷⡆⠀⣴⠛⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠛⠚⠀⢸⡇⣰⠏⠁⠀⠀⠀⠀⢉⠁⢸⠷⠼⠃⠀

#>
#########################################################################################################chillpaca_ad_createuser#################################################################################################################################
<#
.SYNOPSIS
Fonction de creation d'un utilisateur dans l'ad et attribution d'une licence 365 microsoft
.DESCRIPTION
Fonction de creation d'un utilisateur dans l'ad et attribution d'une licence 365 microsoft à partir de caracteristiques dans un fichier csv.
.PARAMETER cheminfichiercsv
emplacement du fichier avec les informations.
.PARAMETER activerlicence365
Active ou non l'attribution de la licence microsoft365 pour l'utilisateur (parametre non obligatoire)
.EXAMPLE
cp_ad_createuser -cheminfichiercsv "emplacement du fichier csv" -activerlicence365
.LINK
https://github.com/jochen1727/
.NOTES
possibilite de se connecter a distance avec la commande invoke-command -computer $adresseduserveurad -script {cp_ad_createuser} ou une session a distance avec la commande enter-pssession
il faut au prealable indiquer les elements $ClientId  $TenantId  $ClientSecret configure dans le tenant 365
#>
function cp_ad_createuser {
    param (
        [parameter(mandatory = $true)]
        [string]$cheminfichiercsv,
        [switch]$activerlicence365
    )
    #verification modules AD et MSgraph ok
    if (-not (Get-Module -ListAvailable -Name ActiveDirectory)) {
        Install-Module -Name ActiveDirectory -Scope CurrentUser
    }
    Import-Module ActiveDirectory
    #importation des utilisateurs depuis le fichier CSV
    $utilisateurs = Import-CSV -Path $cheminfichiercsv -Delimiter ';'
    #creation de l utilisateur
    foreach ($utilisateur in $utilisateurs) {
        # Formatage du SamAccountName : première lettre du prénom + nom, limité à 20 caractères
        $samAccountName = $utilisateur.prenom.Substring(0, 1) + $utilisateur.nom
        $proxyAddresses = "SMTP:" + $utilisateur.addresseemail
        # Tentative de création d'un nouvel utilisateur AD
        try {
            New-ADUser -SamAccountName $samAccountName `
                -UserPrincipalName $utilisateur.upn `
                -Name ("{0} {1}" -f $utilisateur.prenom, $utilisateur.nom) `
                -GivenName $utilisateur.prenom `
                -Surname $utilisateur.nom `
                -Enabled $true `
                -DisplayName ("{0} {1}" -f $utilisateur.prenom, $utilisateur.nom) `
                -Email $utilisateur.adresseprincipale `
                -AccountPassword (ConvertTo-SecureString $utilisateur.password -AsPlainText -Force) `
                -Path $utilisateur.cheminou `
                -PasswordNeverExpires $true `
                -CannotChangePassword $false `
                -ErrorAction Stop `
                -Department $utilisateur.departement `
                -Title $utilisateur.poste `
                -Company $utilisateur.entreprise

            #ajout de l adresse principale et les adresses secondaires
            $adresseprincipale = "SMTP:" + $utilisateur.adresseprincipale
            $adressessecondaires = $utilisateur.adressessecondaires -split ',' | ForEach-Object { "smtp:" + $_ }
            $proxyAddresses = @($adresseprincipale) + $adressessecondaires
            try {
                Set-ADUser -Identity $samAccountName -Add @{ proxyAddresses = $proxyAddresses }
            }
            catch {
                Write-Error "Erreur lors de la mise à jour du parametre proxyadresses de $($utilisateur.SamAccountName): $_"
            }    
            #ajout de groupes
            $groupes = $utilisateur.Groupes -split ','
            foreach ($groupe in $groupes) {
                try {
                    Add-ADGroupMember -Identity $groupe -Members $samAccountName
                    Write-Host "Utilisateur $($samAccountName) ajouté au groupe $groupe."
                }
                catch {
                    Write-Warning "Impossible d'ajouter l'utilisateur $($samAccountName) au groupe $groupe : $_"
                }
            }
            #informations utilisateurs
            $infos = @()
            $infos += Get-ADUser -Filter "SamAccountName -eq `"$samAccountName`"" -Properties * | Select-Object enabled, objectSid, GivenName, Surname, DisplayName, UserPrincipalName, Mail, proxyAddresses, Title, Department, OfficeLocation, AssignedLicenses, DistinguishedName, @{name = "groupes"; Expression = { (Get-ADPrincipalGroupMembership -Identity $samAccountName | Select-Object -ExpandProperty Name) -join ', ' } }
        }
        catch {
            Write-Warning "Impossible de créer l'utilisateur $($utilisateur.prenom) $($utilisateur.nom): $_"
        }
        
        $infos | Format-List
        
    }
   
    if ($activerlicence365) {
        Write-Host "attente de 20 minutes le temps de la synchro AD / entra ID pour attribuer les licences 365"
        Start-ADSyncSyncCycle -PolicyType initial
        Start-Sleep -Seconds 1200
 
        # Connexion mggraph.
        $ClientId = "9e622d1a-2ab0-410e-888e-fac34de0d1ad"
        $TenantId = "c176a1c4-c9c2-405f-9f76-ab88af47ddc6"
        $ClientSecret = "JXO8Q~TSoamLEs~M70792lh6Uw4HbhjeedV7bcOE"
        $Body = @{
            Grant_Type    = "client_credentials"
            Scope         = "https://graph.microsoft.com/.default"
            Client_Id     = $ClientId
            Client_Secret = $ClientSecret
        }

        # Récupérer le jeton d'accès
        $Connection = Invoke-RestMethod -Uri "https://login.microsoftonline.com/$TenantId/oauth2/v2.0/token" -Method POST -Body $Body

        # Récupérer le jeton d'accès
        $token = $Connection.access_token

        # Convertir le jeton d'accès en SecureString
        $SecureToken = ConvertTo-SecureString $token -AsPlainText -Force

        # Se connecter à Microsoft Graph en utilisant le jeton d'accès sécurisé
        Connect-MgGraph -AccessToken $SecureToken
        #Attribution de la licence 365
        foreach ($utilisateur in $utilisateurs) {
            $usageLocation = 'FR'
            update-mguser -UserId $utilisateur.UserPrincipalName -usagelocation $usageLocation
            Set-MgUserLicense -UserId $utilisateur.Id -AddLicenses @{SkuId = '3b555118-da6a-4418-894f-7df1e2096870' } -RemoveLicenses @()
            Write-Host "----------------------------------licences Microsoft 365 de l utilisateur---------------------------------------"
            Get-MgUserLicenseDetail -UserId $upn | select-object SkuPartNumber, ServicePlans | Format-Table -AutoSize
        }
    Write-Host "----------------------------------licences Microsoft 365 utilisees----------------------------------------------"
    Get-MgSubscribedSku
    }
}