<#                                                                                              
      ⡾⣦⡀⠀⠀⡀⠀⣰⢷⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
  ⠀⣠⠗⠛⠽⠛⠋⠉⢳⡃⢨⢧⣄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⣰⠋⠁⠀⠀⠀   ⠀⠙⠛⢾⡈⡏⢧⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀                   
⣼⠉⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀ ⠀⠀⠘⢧⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠸⢦⡀⠀⠀⠀⠀⢀⠀⠀⠀⠀⠀⠀⠀⠀⢸⡄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⢈⠟⠓⠶⠞⠒⢻⣿⡏⢳⡀⠀⠀⠀⠀⢸⡆⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⡴⢉⠀⠀⠀⠀⠀⠈⠛⢁⣸⠇⠀⠀⠀⠀⢺⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⢧⣸⡁⠀⠀⣀⠀⠀⣠⠾⠀⠀⠀⠀⠀⠀⣹⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠉⠓⢲⠾⣍⣀⣀⡿⠃⠀⠀⠀⠀⠀⠀⢸⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⣇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⡿⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⣏⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣿⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⢀⡗⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⡼⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⢸⡄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢟⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⣸⠂⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠺⠦⠤⠤⣤⣄⣀⣀⡀⠀⠀⠀⠀⠀
⠀⠀⠀⣿⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠈⠉⠉⠳⣦⣄⠀⠀
⠀⠀⢀⡷⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠻⣆⠀
⠀⠀⣼⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠘⣆
⠀⠀⣏⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣿
⠀⠀⢹⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣼
⠀⠀⠀⣏⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⡞
⠀⠀⠀⠈⢷⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢠⡇
⠀⠀⠀⠀⠈⢻⣦⣀⠀⣏⠀⠀⠀⠀⠀⠀⢸⡆⠀⠀⢠⡄⠀⠀⠀⠀⠀⢀⡿⠀
⠀⠀⠀⠀⠀⠀⠻⡉⠙⢻⡆⠀⠀⠀⠀⠀⡾⠚⠓⣖⠛⣧⡀⠀⠀⠀⢀⡾⠁⠀
⠀⠀⠀⠀⠀⠀⠀⠙⡇⢀⡿⣦⡀⠀⢀⡴⠃⠀⠀⠈⣷⢈⠷⡆⠀⣴⠛⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠛⠚⠀⢸⡇⣰⠏⠁⠀⠀⠀⠀⢉⠁⢸⠷⠼⠃⠀

#>
#########################################################################################################script creation utilisateur#################################################################################################################################


# fonction cp_ad_createuser

function cp_ad_createuser
{
  <#
.SYNOPSIS
Fonction de creation d'un utilisateur dans l'ad et attribution d'une licence 365 microsoft
.DESCRIPTION
Fonction de creation d'un utilisateur dans l'ad et attribution d'une licence 365 microsoft en copiant un utilisateur existant a partir de son samaccount, neccessite d'avoir des droits administrateurs du domaine et de se connecter sur le controleur de domaine.
.PARAMETER prenom
indiquer le prenom de la personne a creer 
.PARAMETER nom
indiquer le nom de la personne a creer 
.PARAMETER samaccountreference
indiquer le samaccountreference de la personne de reference pour copier ses attributs
.PARAMETER motdepasse
indiquer le mot de passe de la personne (entre 12 et 20 characteres avec une majuscule, un chiffre et un charactere special '[!@#$%^&*()_+\-=\[\]{};':\\|,.<>\/?]`")
.PARAMETER samaccountreference
indiquer la societe de la personne pour son adresse email, sont adresse upn
.PARAMETER identifiantmicrosoftentra
indiquer les identifiants microsoft entra
.EXAMPLE
cp_ad_createuser -prenom john -nom doe -motdepasse azertyAZERTY_ -societe masociete -$identifiantmicrosoftentra
.LINK
https://github.com/jochen1727/
.NOTES
possibilite de se connecter a distance avec la commande invoke-command -computer $adresseduserveurad -script {cp_ad_createuser} ou une session a distance avec la commande enter-pssession
#>

param (
  [parameter(mandatory=$true)]
  [string]$prenom,
  [parameter(mandatory=$true)]
  [string]$nom,
  [parameter(mandatory=$true)]
  [ValidateNotNullOrEmpty()]
  [ValidateRange(4,20)]
  [string]$samaccountreference,
  [parameter(mandatory=$true)]
  [ValidateCount(12,20)]
  [ValidateScript({($_ -match "[A-Z]") -and ($_ -match "[0-9]") -and ($_ -match "'[!@#$%^&*()_+\-=\[\]{};':\\|,.<>\/?]`"" )})]
  [string]$motdepasse,
  [parameter(mandatory=$true)]
  [ValidateSet("lprh","equinoxe","rocard")]
  [string]$societe,
  [parameter(mandatory=$true)]
  [PSCredential]$identifiantmicrosoftentra
)
begin
{
#importation module active-directory
Import-Module ActiveDirectory
Import-Module azuread
import-module msonline
Import-Module ADSync
#fonction affichage lignes
function line
{
return (
write-output "
----------------------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------------------
"
)
}                                                                                                                                                                                        
#fonction enlever les accents
function removestringlatincharacters
{
    PARAM ([string]$String)
    [Text.Encoding]::ASCII.GetString([Text.Encoding]::GetEncoding("Cyrillic").GetBytes($String))
}
#prenom et nom au bon format
$prenom=RemoveStringLatinCharacters($prenom).ToLower()
$nom=RemoveStringLatinCharacters($nom).ToLower()
#Adresse email de la personne selon sa societe
switch ($societe) {
  "lprh" {
    $societedns="lepolerh.com"
  }
  "equinoxe" {
    $societedns="equinoxe-expert.com"
  }
  "rocard" {
    $societedns="crowe-rocard.fr"
  }
 }
$email=RemoveStringLatinCharacters($prenom+$nom+"@"+$societedns).ToLower()
$prenom=removestringlatincharacters($prenom)
#nom complet de la personne avec la premiere lettre du prenom en majuscule et le nom en majuscule
$fullname=$prenom.substring(0,1).toupper()+$prenom.substring(1).tolower()+" "+$nom.ToUpper()
#UPN utilisateur
$upn=$sam+'@'+$societedns
#sam utilisateur et vérification utilisateur présent ou pas 
$sam=.{
  $index=0
  $x=($prenom.toLower())[$index]+$nom.tolower()
  do{
    $usernameExists=try{$null=get-aduser $x;$true}catch{$false}
    if($usernameExists){
      $index+=1
      $x=(($prenom.toLower())[0..$index] -join '')+$nom.tolower()
    }else{
      return $x
    }
  }until(!$usernameExists -or $prenom.length+$nom.length -eq $x.length)
  $number=1
  $x=($prenom.toLower())[$index]+$nom.tolower()
  do{
    $y=$x+"$number"
    $usernameExists=try{$null=get-aduser $y;$true}catch{$false}
    if($usernameExists){
      $number+=1
      $y=$x+"$number"
    }else{
      return $y
    }      
  }until($number -ge 10000)
  return $null
}
if(!$sam){
  write-warning "Utilisateur déja utilisé."
  return $false
}
$attributs_utilisateur_reference = Get-ADUser -Identity $sam -Properties StreetAddress,City,Title,PostalCode,Office,Department,Manager,co,st,Company
}
process 
{
#creation de du compte ad de l utilisateur
New-ADUser -Name $fullName -GivenName $prenom -Surname $nom -EmailAddress $email -SamAccountName $sam -DisplayName $fullName -UserPrincipalName $upn -Instance $attributs_utilisateur_reference  -AccountPassword (ConvertTo-SecureString $motdepasse -AsPlainText -Force) -ChangePasswordAtLogon $false -Enabled $true -PasswordNeverExpires $false
$groupes_utilisateur_references = Get-ADPrincipalGroupMembership -Identity $samaccountreference
Add-ADPrincipalGroupMembership -Identity $sam -MemberOf $groupes_utilisateur_references
Set-ADUser -Identity $sam -Add @{proxyAddresses="SMTP:$email"}
$OU=((Get-ADUser -Identity $samaccountreference).DistinguishedName -split '(?<!\\),', 2)[-1]
$utilisateur_destination = Get-ADUser -Identity $samaccountreference
$utilisateur_destination | Move-ADObject -TargetPath $OU
#ceation dossier utilisateur SCAN
$dossier_utilisateur=$prenom.toupper().Substring(0,1)+$nom.toupper().Substring(0,2)
Write-Host "création du dossier particulier de scan dans le dossir commun, scan, perso avec le nom suivant : $dossier_utilisateur"
Invoke-Command -ComputerName srv-fs01 -ScriptBlock { 
new-item "D:\Rocard\Commun\Scan\Individuel\$using:dossier_utilisateur" -Type directory }
}
end
{
# Récapitulatif utilisateur
Write-host "Recapitulatif utisateur :"
get-aduser -identity $sam_chara -Properties * | format-list *
#Forcer synchro AD connect
Write-Host "synchro en cours sur azure AD, attendre 5 minutes"
Start-ADSyncSyncCycle -PolicyType Delta
Start-Sleep -Seconds 300
#Connect-MsolService
Connect-MsolService -credential $identifiantmicrosoftentra
$licenseOption = New-MsolLicenseOptions -AccountSkuId "crowerocardfr:O365_BUSINESS_ESSENTIALS" -DisabledPlans MCOSTANDARD,YAMMER_ENTERPRISE,SWAY,PROJECTWORKMANAGEMENT,POWERAPPS_O365_P1,FLOW_O365_P1,FORMS_PLAN_E1,STREAM_O365_SMB,KAIZALA_O365_P2,MYANALYTICS_P2,WHITEBOARD_PLAN1,DYN365_CDS_O365_P1,PROJECT_O365_P1,CDS_O365_P1,POWER_VIRTUAL_AGENTS_O365_P1,VIVA_LEARNING_SEEDED,MICROSOFTBOOKINGS
Set-MsolUser -UserPrincipalName $upn -UsageLocation "FR"
Set-MsolUserLicense -UserPrincipalName $upn -AddLicenses "crowerocardfr:O365_BUSINESS_ESSENTIALS" -LicenseOptions $licenseOption
}
}



