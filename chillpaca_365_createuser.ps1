<#                                                                                              
      ⡾⣦⡀⠀⠀⡀⠀⣰⢷⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
  ⠀⣠⠗⠛⠽⠛⠋⠉⢳⡃⢨⢧⣄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⣰⠋⠁⠀⠀⠀   ⠀⠙⠛⢾⡈⡏⢧⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀                   
⣼⠉⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀ ⠀⠀⠘⢧⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠸⢦⡀⠀⠀⠀⠀⢀⠀⠀⠀⠀⠀⠀⠀⠀⢸⡄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⢈⠟⠓⠶⠞⠒⢻⣿⡏⢳⡀⠀⠀⠀⠀⢸⡆⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⡴⢉⠀⠀⠀⠀⠀⠈⠛⢁⣸⠇⠀⠀⠀⠀⢺⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⢧⣸⡁⠀⠀⣀⠀⠀⣠⠾⠀⠀⠀⠀⠀⠀⣹⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠉⠓⢲⠾⣍⣀⣀⡿⠃⠀⠀⠀⠀⠀⠀⢸⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⣇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⡿⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⣏⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣿⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⢀⡗⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⡼⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⢸⡄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢟⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⣸⠂⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠺⠦⠤⠤⣤⣄⣀⣀⡀⠀⠀⠀⠀⠀
⠀⠀⠀⣿⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠈⠉⠉⠳⣦⣄⠀⠀
⠀⠀⢀⡷⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠻⣆⠀
⠀⠀⣼⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠘⣆
⠀⠀⣏⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣿
⠀⠀⢹⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣼
⠀⠀⠀⣏⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⡞
⠀⠀⠀⠈⢷⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢠⡇
⠀⠀⠀⠀⠈⢻⣦⣀⠀⣏⠀⠀⠀⠀⠀⠀⢸⡆⠀⠀⢠⡄⠀⠀⠀⠀⠀⢀⡿⠀
⠀⠀⠀⠀⠀⠀⠻⡉⠙⢻⡆⠀⠀⠀⠀⠀⡾⠚⠓⣖⠛⣧⡀⠀⠀⠀⢀⡾⠁⠀
⠀⠀⠀⠀⠀⠀⠀⠙⡇⢀⡿⣦⡀⠀⢀⡴⠃⠀⠀⠈⣷⢈⠷⡆⠀⣴⠛⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠛⠚⠀⢸⡇⣰⠏⠁⠀⠀⠀⠀⢉⠁⢸⠷⠼⠃⠀

#>
#####################################################################################################script creation utilisateur 365#################################################################################################################################


# fonction cp_365_createuser

function cp_365_createuser {
    <#
  .SYNOPSIS
  Fonction de creation d'un utilisateur dans le tenant 365 et attribution d'une licence 365 microsoft depuis un fichier csv
  .DESCRIPTION
Fonction de creation d'un utilisateur dans le tenant 365 et attribution d'une licence 365 microsoft depuis un fichier csv
  .PARAMETER cheminfichiercsv
  Emplacement du fichier csv avec les parametres pour la creation de l utilisateur
  .EXAMPLE
  cp_365_createuser -cheminfichiercsv chemin du fichier au format csv
  .LINK
  https://github.com/jochen1727/
  .NOTES
  Il faut avoir les droits suivants sur MSGPRAPH dans 365 :"User.ReadWrite.All", "Group.ReadWrite.All", "Directory.ReadWrite.All" 
  #>
    param (
        [parameter(mandatory = $true)]
        [string]$cheminfichiercsv
    )

    begin {
        # Installation du module Microsoft Graph API si besoin et importation.
        Install-Module -name Microsoft.Graph
        # Connexion mggraph. 
        Connect-MgGraph -Scope "User.ReadWrite.All", "Group.ReadWrite.All", "Directory.ReadWrite.All"
        $utilisateurs = Import-CSV -Path $cheminfichiercsv -Delimiter ","
    }
    process {
        Foreach ($utilisateur in $utilisateurs) {
            If ($null -ne (Get-MgUser -UserId $utilisateur.UserPrincipalName -ErrorAction SilentlyContinue)) {
                Write-Host "$($utilisateur.UserPrincipalName) - Existe dans Azure AD"
            }
            Else {
                Try {
                    Write-Host "$($utilisateur.UserPrincipalName) - Création du compte dans Azure AD"
    
                    $PasswordProfile = @{
                        Password                             = $utilisateur.Password
                        ForceChangePasswordNextSignIn        = $true
                        ForceChangePasswordNextSignInWithMfa = $true
                    }
        
                    $utilisateurParams = @{
                        GivenName         = $utilisateur.GivenName
                        Surname           = $utilisateur.Surname
                        DisplayName       = $utilisateur.DisplayName
                        MailNickName      = $utilisateur.MailNickName
                        Mail              = $utilisateur.Mail
                        UserPrincipalName = $utilisateur.UserPrincipalName
                        Department        = $utilisateur.Department
                        JobTitle          = $utilisateur.JobTitle
                        Mobile            = $utilisateur.Mobile
                        Country           = $utilisateur.Country
                        AccountEnabled    = $true
                        Password          = $PasswordProfile
                    }
          
        
                    #creation de l utilisateur.
                    New-MgUser @UserParams -ErrorAction Stop

                    #creation des groupes.
                    $groupes = $utilisateur.Groupes -split ','
                    $user = Get-MgUser -Filter "userPrincipalName eq '$utilisateur.UserPrincipalName'"
                    foreach ($groupe in $groupes) {
                        $groupedata = Get-MgGroup -Filter "displayName eq '$groupe'"
                        if ($groupedata -ne $null) {
                            Add-MgGroupMember -GroupId $groupedata.Id -UserId $user.Id
                        }
                        else {
                            Write-Host "Impossible de trouver le groupe $($groupName)."
                        }
                    }
                    #Attribution de la licence 365
                    $usageLocation = 'FR'
                    update-mguser -UserId $upn -usagelocation $usageLocation
                    Set-MgUserLicense -UserId (Get-MgUser -UserId $user.UserPrincipalName).Id -Addlicenses @{SkuId = '3b555118-da6a-4418-894f-7df1e2096870’ } -RemoveLicenses @()
                    
                }
                Catch {
                    # Sinon on affice le message d'erreur.
                    write-warning "Une erreur est survenue" 
                    write-host $_.Exception.Message 
                }
       
            }
             
        }
           
    }
    
    end {

        #resume des infos de l utilisateur
        line
        Write-Host "-----------------------------------------resume utilisateur-----------------------------------------------------"
        Get-MgUser -UserId $user.UserPrincipalName | select-object ID, GivenName, Surname, DisplayName, UserPrincipalName, Mail, proxyAddresses, JobTitle, Department, OfficeLocation, AssignedLicenses
        Write-Host "-----------------------------------------groupes de l utilisateur-----------------------------------------------"
        Get-MgUserTransitiveMemberOf -UserId $user.UserPrincipalName -Property displayName | ? { $_.AdditionalProperties.'@odata.type' -eq "#microsoft.graph.group" } | select-object @{n = "Name"; e = { $_.AdditionalProperties.displayName } } 
        Get-MgUserOwnedObject -UserId $user.UserPrincipalName -Property id, displayName | select-object @{n = "Name"; e = { $_.AdditionalProperties.displayName } }
        Write-Host "----------------------------------licences Microsoft 365 de l utilisateur---------------------------------------"
        Get-MgUserLicenseDetail -UserId $user.UserPrincipalNamepn | select-object SkuPartNumber, ServicePlans | ft -AutoSize
        line
        Write-Host "----------------------------------licences Microsoft 365 utilisees----------------------------------------------"
        Get-MgSubscribedSku
    }
}



