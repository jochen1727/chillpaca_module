<#                                                                                              
      ⡾⣦⡀⠀⠀⡀⠀⣰⢷⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
  ⠀⣠⠗⠛⠽⠛⠋⠉⢳⡃⢨⢧⣄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⣰⠋⠁⠀⠀⠀   ⠀⠙⠛⢾⡈⡏⢧⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀                   
⣼⠉⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀ ⠀⠀⠘⢧⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠸⢦⡀⠀⠀⠀⠀⢀⠀⠀⠀⠀⠀⠀⠀⠀⢸⡄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⢈⠟⠓⠶⠞⠒⢻⣿⡏⢳⡀⠀⠀⠀⠀⢸⡆⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⡴⢉⠀⠀⠀⠀⠀⠈⠛⢁⣸⠇⠀⠀⠀⠀⢺⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⢧⣸⡁⠀⠀⣀⠀⠀⣠⠾⠀⠀⠀⠀⠀⠀⣹⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠉⠓⢲⠾⣍⣀⣀⡿⠃⠀⠀⠀⠀⠀⠀⢸⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⣇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⡿⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⣏⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣿⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⢀⡗⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⡼⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⢸⡄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢟⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⣸⠂⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠺⠦⠤⠤⣤⣄⣀⣀⡀⠀⠀⠀⠀⠀
⠀⠀⠀⣿⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠈⠉⠉⠳⣦⣄⠀⠀
⠀⠀⢀⡷⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠻⣆⠀
⠀⠀⣼⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠘⣆
⠀⠀⣏⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣿
⠀⠀⢹⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣼
⠀⠀⠀⣏⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⡞
⠀⠀⠀⠈⢷⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢠⡇
⠀⠀⠀⠀⠈⢻⣦⣀⠀⣏⠀⠀⠀⠀⠀⠀⢸⡆⠀⠀⢠⡄⠀⠀⠀⠀⠀⢀⡿⠀
⠀⠀⠀⠀⠀⠀⠻⡉⠙⢻⡆⠀⠀⠀⠀⠀⡾⠚⠓⣖⠛⣧⡀⠀⠀⠀⢀⡾⠁⠀
⠀⠀⠀⠀⠀⠀⠀⠙⡇⢀⡿⣦⡀⠀⢀⡴⠃⠀⠀⠈⣷⢈⠷⡆⠀⣴⠛⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠛⠚⠀⢸⡇⣰⠏⠁⠀⠀⠀⠀⢉⠁⢸⠷⠼⠃⠀

#>
#########################################################################################################chillpaca_365_createuser#################################################################################################################################
<#
.SYNOPSIS
Fonction de creation d'un utilisateur dans Microsoft 365 et attribution d'une licence 365 microsoft
.DESCRIPTION
Fonction de creation d'un utilisateur dans Microsoft 365 et attribution d'une licence 365 microsoft à partir de caracteristiques dans un fichier csv.
.EXAMPLE
cp_365_createuser -cheminfichiercsv "emplacement du fichier csv"
.LINK
https://github.com/jochen1727/
.NOTES
#>
function cp_365_createuser {
    param (
        [parameter(mandatory = $true)]
        [string]$cheminfichiercsv
    )
    #installations et importations modules si besoins
    begin {
        if (-not (Get-Module -Name Microsoft.Graph.Beta -ListAvailable -ErrorAction SilentlyContinue)) {
            Write-Host "Le module MSGraph beta n'est pas installé. Installation en cours..."
            # Installer le module MSGraph beta 
            try {
                Install-Module -Name Microsoft.Graph.Beta -AllowPrerelease -Scope AllUsers -Force -Verbose
                Write-Host "Le module MSGraph beta a été installé avec succès."
            }
            catch {
                Write-Host "Une erreur s'est produite lors de l'installation du module MSGraph beta : $_" -ForegroundColor Red
            }
        }
        else {
         (write-host "Le module Ms Graph est déjà installéé.`nimportation du module Microsoft.Graph.Beta")
            import-module -name Microsoft.Graph.Beta
        }
        # Connexion mggraph.
        $ClientId = ""
        $TenantId = ""
        $ClientSecret = ""
        $Body = @{
            Grant_Type    = "client_credentials"
            Scope         = "https://graph.microsoft.com/.default"
            Client_Id     = $ClientId
            Client_Secret = $ClientSecret
        }

        # Récupérer le jeton d'accès
        $Connection = Invoke-RestMethod -Uri "https://login.microsoftonline.com/$TenantId/oauth2/v2.0/token" -Method POST -Body $Body

        # Récupérer le jeton d'accès
        $token = $Connection.access_token

        # Convertir le jeton d'accès en SecureString
        $SecureToken = ConvertTo-SecureString $token -AsPlainText -Force

        # Se connecter à Microsoft Graph en utilisant le jeton d'accès sécurisé
        Connect-MgGraph -AccessToken $SecureToken

        # Importer les utilisateurs depuis le fichier CSV
        $utilisateurs = Import-CSV -Path $cheminfichiercsv -Delimiter ","

        $listeutilisateurs = @()
    }

    process {
        foreach ($utilisateur in $utilisateurs) {
            Try {
                # Vérifier si l'utilisateur existe dans Azure AD
                $user = Get-MgUser -UserId $utilisateur.UserPrincipalName -ErrorAction SilentlyContinue
                if ($null -ne $user) {
                    Write-Host "$($utilisateur.UserPrincipalName) - Existe dans Azure AD"
                }
                Else {
                    Write-Host "$($utilisateur.UserPrincipalName) - Création du compte dans Azure AD"

                    $PasswordProfile = @{
                        Password                             = $utilisateur.Password
                        ForceChangePasswordNextSignIn        = $true
                        ForceChangePasswordNextSignInWithMfa = $true
                    }

                    $utilisateurParams = @{
                        GivenName         = $utilisateur.GivenName
                        Surname           = $utilisateur.Surname
                        DisplayName       = $utilisateur.DisplayName
                        MailNickName      = $utilisateur.MailNickName
                        Mail              = $utilisateur.Mail
                        UserPrincipalName = $utilisateur.UserPrincipalName
                        Department        = $utilisateur.Department
                        JobTitle          = $utilisateur.JobTitle
                        #  MobilePhone       = $utilisateur.MobilePhone
                        Country           = $utilisateur.Country
                        AccountEnabled    = $true
                        PasswordProfile   = $PasswordProfile
                    }
                    # Création de l'utilisateur
                    New-MgUser @utilisateurParams -ErrorAction SilentlyContinue

                    # Création du groupe
                    $groupes = $utilisateur.Groupes -split ';'
            
                    foreach ($groupe in $groupes) {
                        $Groupid = (Get-MgGroup | Where-Object { $_.DisplayName -eq "$($groupe)" }).id
                        $odadaID = "https://graph.microsoft.com/v1.0/users/" + [System.Uri]::EscapeDataString($utilisateur.UserPrincipalName)
                        New-MgGroupMemberByRef -GroupId $GroupId -OdataId $odadaID -erroraction SilentlyContinue
                    }
                    # Affichage des infos utilisateurs
                  
                    $listeutilisateurs += Get-MgBetaUser -UserId $utilisateur.UserPrincipalName | select-object -Property GivenName, Surname, DisplayName, MailNickName, Mail, UserPrincipalName, Department, JobTitle, Country, AccountEnabled, @{Name = 'Groupes'; Expression = { "$($listeNomsMembres)" } }
                  
                  
                    #Attribution de la licence 365
                    
                    $usageLocation = 'FR'
                    update-mguser -UserId $utilisateur.UserPrincipalName -usagelocation $usageLocation
                    Set-MgUserLicense -UserId $utilisateur.Id -AddLicenses @{SkuId = '3b555118-da6a-4418-894f-7df1e2096870' } -RemoveLicenses @()
                }
            }
            Catch {
                # Afficher un avertissement en cas d'erreur
                Write-Warning "Une erreur est survenue lors de la création de l'utilisateur $($utilisateur.UserPrincipalName)"
                Write-Host $_.Exception.Message 
            }
        }
    }
    end {
        $listeutilisateurs | Format-Table
    }
}

